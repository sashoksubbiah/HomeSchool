<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Junior Lab</title>
    <style>
        :root {
            --water-color: #4facfe;
            --water-surface: #00f2fe;
            --bg-color: #fdfbf7;
            --ui-font: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            --primary-color: #FF9800;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: var(--ui-font);
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Global Layout --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: none; /* Hidden by default */
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
        }

        .splash-title {
            font-size: 5rem;
            margin: 0;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            animation: float 3s ease-in-out infinite;
        }

        .splash-icon {
            font-size: 8rem;
            margin-bottom: 20px;
            display: inline-block;
            animation: spin-slow 10s linear infinite;
        }
        
        @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        .enter-btn {
            background: white;
            color: #FF5722;
            font-size: 2rem;
            padding: 20px 60px;
            border: none;
            border-radius: 50px;
            margin-top: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .enter-btn:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .enter-btn:active { transform: scale(0.95); }

        /* --- HOME SCREEN --- */
        #home-screen {
            background: #fffbe6;
            align-items: center;
            overflow-y: auto;
        }

        .hero-header {
            background: #FF9800;
            color: white;
            width: 100%;
            padding: 30px 20px;
            text-align: center;
            border-radius: 0 0 50% 50% / 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .hero-title { font-size: 3rem; margin: 0; text-shadow: 2px 2px 0px #E65100; }
        .hero-subtitle { font-size: 1.2rem; margin-top: 10px; opacity: 0.9; }

        #curriculum-container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        .level-section {
            width: 90%;
            margin-bottom: 40px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .level-title {
            font-size: 1.5rem;
            color: #444;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .lesson-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 3px solid #eee;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 240px;
        }

        .lesson-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .lesson-card.unlocked { border-color: #4CAF50; }
        .lesson-card.locked { opacity: 0.7; cursor: not-allowed; filter: grayscale(1); background: #f9f9f9; }

        .card-icon { font-size: 4rem; margin-bottom: 10px; display: block; }
        .card-title { font-size: 1.3rem; color: #333; margin: 5px 0; font-weight: bold; }
        .card-desc { color: #666; font-size: 0.9rem; line-height: 1.4; margin-bottom: 10px; }
        
        .play-badge { background: #4CAF50; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-top: auto; }
        .lock-badge { color: #999; font-weight: bold; margin-top: auto; border: 2px solid #ddd; padding: 5px 15px; border-radius: 20px; }

        /* --- EXPERIMENT SCREEN --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; /* ENABLE SCROLLING */
            -webkit-overflow-scrolling: touch;
        }

        #robot-container {
            position: absolute;
            bottom: 20px; left: 20px;
            z-index: 400;
            display: flex; align-items: flex-end;
            pointer-events: none;
        }

        #robot-avatar {
            font-size: 80px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            transition: transform 0.2s;
        }
        .speaking { animation: bounce 0.5s infinite alternate; }

        #speech-bubble {
            background: white; padding: 15px 25px;
            border-radius: 20px 20px 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 60px; margin-left: -10px;
            max-width: 250px; font-size: 1.1rem; color: #333;
            border: 2px solid #333; opacity: 0; transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #speech-bubble.visible { opacity: 1; transform: scale(1); }

        #hud {
            width: 100%; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); z-index: 100;
            box-sizing: border-box;
            flex-shrink: 0; /* Prevent HUD from shrinking */
        }

        .home-btn {
            background: #f0f0f0; border: none; font-size: 1.5rem;
            cursor: pointer; padding: 5px 15px; border-radius: 10px;
            transition: background 0.2s;
        }
        .home-btn:hover { background: #e0e0e0; }

        /* Sink/Float UI */
        .phase-tracker { display: flex; gap: 10px; }
        .phase { padding: 8px 15px; background: #eee; border-radius: 15px; color: #aaa; font-size: 0.9rem; font-weight: bold; }
        .phase.active { background: #FF9800; color: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #lab-area { flex: 1; width: 100%; position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; min-height: 400px; }
        #tank-container {
            position: relative; width: 80%; max-width: 600px; height: 55vh;
            border: 8px solid #333; border-top: none; border-radius: 0 0 20px 20px;
            background: rgba(255, 255, 255, 0.5); overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: box-shadow 0.3s;
        }
        .highlight-tank { box-shadow: 0 0 30px #2196F3 !important; border-color: #2196F3 !important; }
        #water {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80%;
            background: linear-gradient(to bottom, var(--water-surface), var(--water-color));
            opacity: 0.8; border-top: 4px solid rgba(255,255,255,0.8);
        }
        .bubble { position: absolute; background: rgba(255,255,255,0.6); border-radius: 50%; animation: rise 4s infinite ease-in; }

        #shelf {
            position: absolute; top: 90px; right: 20px; width: 90px;
            background: #8d6e63; border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.2); z-index: 50;
        }
        .game-item {
            font-size: 55px; cursor: grab; user-select: none;
            position: absolute; transition: transform 0.1s;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2)); z-index: 60;
        }
        .game-item:active { cursor: grabbing; transform: scale(1.1); }

        #hypothesis-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
            z-index: 200; display: none; width: 80%; max-width: 350px; border: 4px solid #FF9800;
        }
        .guess-btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 12px; font-size: 1.2rem;
            font-family: inherit; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .btn-float { background: #E1F5FE; color: #0288D1; border: 2px solid #0288D1; }
        .btn-sink { background: #FBE9E7; color: #D84315; border: 2px solid #D84315; }

        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 300; }
        
        #intro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(253, 251, 247, 0.95); z-index: 500;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        #start-btn {
            background: #4CAF50; color: white; font-size: 1.5rem;
            padding: 20px 40px; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 8px 0 #388E3C; margin-top: 20px;
        }
        #start-btn:active { transform: translateY(8px); box-shadow: none; }

        #result-card {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: none; flex-direction: column;
            align-items: center; text-align: center; z-index: 450; border: 4px solid #4CAF50;
        }
        .result-title { font-size: 2rem; margin: 0; color: #333; }
        .result-fact { background: #E8F5E9; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 1.1rem; line-height: 1.5; color: #2E7D32; border: 1px solid #C8E6C9; }
        .reset-btn { background: #333; color: white; padding: 15px 30px; border-radius: 30px; font-size: 1.2rem; border: none; cursor: pointer; pointer-events: auto; }

        /* --- MATTER EXPERIMENT STYLES --- */
        #matter-stage {
            flex: 1; width: 100%; position: relative; display: none; /* Toggled via JS */
            flex-direction: column; align-items: center; justify-content: flex-start; /* Changed for scroll */
            padding-top: 20px; padding-bottom: 50px;
        }

        .beaker-container {
            position: relative; width: 250px; height: 300px;
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 20px;
            flex-shrink: 0; /* Prevent squishing */
        }
        .beaker {
            width: 200px; height: 250px; border: 8px solid #555; border-top: none;
            border-radius: 0 0 20px 20px; background: rgba(255,255,255,0.3);
            position: relative; overflow: hidden;
        }
        .beaker::before { /* Rim */
            content: ''; position: absolute; top: -5px; left: -10px; right: -10px; height: 10px;
            border: 8px solid #555; border-radius: 10px;
        }
        
        .substance {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            transition: all 1s ease; display: flex; justify-content: center; align-items: center;
            font-size: 4rem;
        }
        
        .state-solid { height: 40%; background: #E1F5FE; align-items: center; } 
        .state-solid::after { content: 'üßä'; }
        
        .state-liquid { height: 60%; background: #2196F3; opacity: 0.8; align-items: flex-end; padding-bottom: 20px; }
        .state-liquid::after { content: 'üíß'; animation: float 2s infinite ease-in-out; }

        .state-gas { height: 100%; background: transparent; align-items: flex-start; padding-top: 40px; }
        .state-gas::after { 
            content: '‚òÅÔ∏è'; 
            animation: rise-expand 2.5s infinite linear; 
            opacity: 0.7; 
            font-size: 5rem; 
        }

        @keyframes rise-expand { 
            0% { bottom: -20px; transform: translateX(0) scale(1); opacity: 0; } 
            50% { opacity: 1; } 
            100% { bottom: 100%; transform: translateX(20px) scale(1.5); opacity: 0; } 
        }

        .burner {
            width: 200px; height: 20px; background: #333; margin-top: 5px; border-radius: 5px;
            position: relative; display: flex; justify-content: center;
        }
        .flame {
            font-size: 3rem; position: absolute; top: 10px; opacity: 0; transition: opacity 0.5s;
        }
        .flame.active { opacity: 1; animation: pulse 0.5s infinite alternate; }

        .controls-area {
            display: flex; gap: 20px; align-items: center; background: white;
            padding: 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px; flex-shrink: 0;
        }

        .temp-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 2rem;
            cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-heat { background: #FF5722; color: white; }
        .btn-cool { background: #2196F3; color: white; }
        .temp-btn:active { transform: translateY(4px); box-shadow: none; }

        .thermometer-container {
            width: 20px; height: 200px; background: #eee; border-radius: 10px;
            position: absolute; right: -50px; bottom: 0; border: 2px solid #999;
            overflow: hidden;
        }
        .mercury {
            width: 100%; height: 20%; background: #F44336;
            position: absolute; bottom: 0; transition: height 1s;
        }

        .chemical-area {
            margin-top: 30px; display: flex; align-items: center; gap: 15px;
            background: #FFF3E0; padding: 10px 20px; border-radius: 15px; border: 2px dashed #FF9800;
            flex-shrink: 0;
        }

        /* --- Explanation Cards (New) --- */
        .explanation-container {
            margin-top: 30px;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
        }

        .expl-card {
            background: white;
            padding: 15px;
            border-radius: 15px;
            border-left: 6px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
            opacity: 0.6;
            text-align: left;
        }

        .expl-card.active {
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .expl-card h3 { margin: 0 0 5px 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .expl-card p { margin: 0; font-size: 1rem; color: #555; line-height: 1.4; }

        /* Specific colors */
        .expl-card.solid.active { border-left-color: #2196F3; background: #E3F2FD; }
        .expl-card.liquid.active { border-left-color: #FF9800; background: #FFF3E0; }
        .expl-card.gas.active { border-left-color: #F44336; background: #FFEBEE; }

    </style>
</head>
<body>

    <!-- SCREEN 0: SPLASH SCREEN -->
    <div id="splash-screen" class="screen active">
        <div class="splash-icon">üß™</div>
        <h1 class="splash-title">Junior Lab</h1>
        <p style="font-size: 1.5rem; opacity: 0.9;">Explore. Learn. Play.</p>
        <button class="enter-btn" onclick="enterLab()">Enter Lab üöÄ</button>
    </div>

    <!-- SCREEN 1: HOME / TOC -->
    <div id="home-screen" class="screen">
        <header class="hero-header">
            <h1 class="hero-title">üî¨ Junior Lab</h1>
            <p class="hero-subtitle">What do you want to discover today?</p>
        </header>
        <div id="curriculum-container"></div>
    </div>

    <!-- SCREEN 2: EXPERIMENT -->
    <div id="experiment-screen" class="screen">
        <div id="game-container">
            <canvas id="confetti-canvas"></canvas>

            <!-- Top HUD -->
            <div id="hud">
                <button class="home-btn" onclick="goHome()">üè† Home</button>
                <div id="sinkfloat-ui" style="display:none;">
                    <div class="phase-tracker">
                        <div class="phase" id="ph-1">1. Ask</div>
                        <div class="phase" id="ph-2">2. Guess</div>
                        <div class="phase" id="ph-3">3. Test</div>
                    </div>
                </div>
                <div id="matter-ui" style="display:none; font-weight:bold; font-size:1.2rem; color:#555;">
                    States of Matter
                </div>
                <div style="width: 50px;"></div> 
            </div>

            <!-- Intro Overlay -->
            <div id="intro-overlay">
                <div style="font-size: 80px; margin-bottom: 20px;">ü§ñ</div>
                <h1 style="color: #333;" id="intro-title">Experiment</h1>
                <p style="color: #666; font-size: 1.2rem;">I am Robo-Prof.<br>Turn on your sound so I can teach you!</p>
                <button id="start-btn">Start Experiment üîä</button>
            </div>

            <!-- Robot Teacher -->
            <div id="robot-container">
                <div id="speech-bubble">Hello! I'm Robo-Prof!</div>
                <div id="robot-avatar">ü§ñ</div>
            </div>

            <!-- === EXPERIMENT 1: SINK OR FLOAT === -->
            <div id="sinkfloat-stage" style="width:100%; height:100%; display:none;">
                <div id="shelf"></div>
                <div id="lab-area">
                    <div id="tank-container">
                        <div id="water"></div>
                    </div>
                </div>
            </div>

            <!-- === EXPERIMENT 2: STATES OF MATTER === -->
            <div id="matter-stage">
                <div class="beaker-container">
                    <div class="beaker">
                        <div class="substance state-solid" id="matter-substance"></div>
                    </div>
                    <div class="burner">
                        <div class="flame" id="matter-flame">üî•</div>
                    </div>
                    <div class="thermometer-container">
                        <div class="mercury" id="matter-mercury"></div>
                    </div>
                </div>

                <div class="controls-area">
                    <button class="temp-btn btn-cool" onclick="changeTemp(-1)">‚ùÑÔ∏è</button>
                    <div style="text-align:center; width: 120px;">
                        <div style="font-weight:bold; color:#555;">Temperature</div>
                        <div id="temp-display" style="font-size:1.5rem;">Freezing</div>
                    </div>
                    <button class="temp-btn btn-heat" onclick="changeTemp(1)">üî•</button>
                </div>

                <!-- Detailed Explanation Cards -->
                <div class="explanation-container">
                    <div class="expl-card solid" id="expl-solid">
                        <h3>üßä Solid (Ice)</h3>
                        <p>Brr! It is cold. The tiny particles hold hands tightly and don't move much. They form a hard shape.</p>
                    </div>
                    <div class="expl-card liquid" id="expl-liquid">
                        <h3>üíß Liquid (Water)</h3>
                        <p>Getting warmer! Heat gives particles energy to dance and slide around each other. This makes water flow!</p>
                    </div>
                    <div class="expl-card gas" id="expl-gas">
                        <h3>‚òÅÔ∏è Gas (Steam)</h3>
                        <p>Super Hot! The particles have so much energy they fly apart! They spread out to fill all the space.</p>
                    </div>
                </div>

                <!-- Chemical Change Demo -->
                <div class="chemical-area">
                    <div style="font-size:2rem;" id="match-icon">üìç</div>
                    <button class="guess-btn" style="background:#333; color:white; padding:5px 15px; font-size:1rem; width:auto; margin:0;" onclick="burnMatch()">Burn Match</button>
                </div>
            </div>
            
            <!-- Result/Hypothesis Popups (SinkFloat Only) -->
            <div id="result-card">
                <div style="font-size: 4rem;" id="res-icon">üçé</div>
                <h2 class="result-title" id="res-title">It Floats!</h2>
                <div class="result-fact" id="res-desc">Explanation...</div>
                <button class="reset-btn" id="next-item-btn">Next Experiment ‚û°Ô∏è</button>
            </div>

            <div id="hypothesis-panel">
                <h2>Make a Hypothesis</h2>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">(That means make a smart Guess!)</p>
                <div style="font-size: 3rem; margin-bottom: 10px;" id="hypo-icon">üçé</div>
                <button class="guess-btn btn-float pulse-anim" onclick="makeHypothesis(true)">It will FLOAT ‚¨ÜÔ∏è</button>
                <button class="guess-btn btn-sink pulse-anim" onclick="makeHypothesis(false)">It will SINK ‚¨áÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        // --- Navigation Logic ---
        function enterLab() {
            document.getElementById('splash-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
        }

        // --- Curriculum Data Structure ---
        const CURRICULUM = [
            {
                title: "1. Science: The Physical World",
                color: "#E1F5FE", 
                topics: [
                    { 
                        id: 'sinkfloat', 
                        title: "The Scientific Method", 
                        icon: "üåä", 
                        desc: "Sink or Float? Ask, Guess, Test!", 
                        locked: false 
                    },
                    { 
                        id: 'matter', 
                        title: "States of Matter", 
                        icon: "üßä", 
                        desc: "Solid, Liquid, Gas & Changes.", 
                        locked: false // UNLOCKED NOW
                    }
                ]
            },
            {
                title: "2. History: The Story of Time",
                color: "#FFF3E0", 
                topics: [
                    { id: 'dinos', title: "Dinosaurs", icon: "ü¶ï", desc: "Giants of the past.", locked: true },
                    { id: 'pyramids', title: "Ancient Egypt", icon: "üî∫", desc: "Pyramids and Pharaohs.", locked: true }
                ]
            },
            {
                title: "3. Economics: Value & Choices",
                color: "#E8F5E9", 
                topics: [
                    { id: 'barter', title: "Trading", icon: "ü§ù", desc: "Trading toys for snacks.", locked: true },
                    { id: 'money', title: "What is Money?", icon: "üí∞", desc: "Coins and piggy banks.", locked: true }
                ]
            },
            {
                title: "4. Literature: Story & Meaning",
                color: "#F3E5F5", 
                topics: [
                    { id: 'fables', title: "Aesop's Fables", icon: "ü¶ä", desc: "Stories with a lesson.", locked: true },
                    { id: 'poetry', title: "Fun Rhymes", icon: "üìù", desc: "Playing with words.", locked: true }
                ]
            },
            {
                title: "5. Systems & Logic (Engineering)",
                color: "#ECEFF1", 
                topics: [
                    { id: 'patterns', title: "Pattern Spotting", icon: "üß©", desc: "Red, Blue, Red...?", locked: true },
                    { id: 'coding', title: "Robot Logic", icon: "ü§ñ", desc: "How to give instructions.", locked: true }
                ]
            },
            {
                title: "6. Citizenship & Ethics",
                color: "#FFEBEE", 
                topics: [
                    { id: 'sharing', title: "Sharing is Caring", icon: "‚ù§Ô∏è", desc: "Why we share with others.", locked: true },
                    { id: 'feelings', title: "Understanding Feelings", icon: "üòä", desc: "Happy, Sad, and Angry.", locked: true }
                ]
            }
        ];

        // --- Render Curriculum ---
        function renderHome() {
            const container = document.getElementById('curriculum-container');
            container.innerHTML = ''; 

            CURRICULUM.forEach(level => {
                const section = document.createElement('div');
                section.className = 'level-section';
                section.style.background = level.color; 
                
                const title = document.createElement('div');
                title.className = 'level-title';
                title.innerText = level.title;
                section.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'toc-grid';

                level.topics.forEach(topic => {
                    const card = document.createElement('div');
                    card.className = `lesson-card ${topic.locked ? 'locked' : 'unlocked'}`;
                    
                    if (!topic.locked) {
                        card.onclick = () => loadExperiment(topic.id);
                    }

                    card.innerHTML = `
                        <div>
                            <span class="card-icon">${topic.icon}</span>
                            <div class="card-title">${topic.title}</div>
                            <div class="card-desc">${topic.desc}</div>
                        </div>
                        ${topic.locked 
                            ? '<div class="lock-badge">üîí Locked</div>' 
                            : '<div class="play-badge">PLAY ‚ñ∂</div>'}
                    `;
                    grid.appendChild(card);
                });

                section.appendChild(grid);
                container.appendChild(section);
            });
        }
        renderHome();

        // --- EXPERIMENT LOADER ---
        let currentExperimentId = '';

        function loadExperiment(id) {
            currentExperimentId = id;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('experiment-screen').classList.add('active');
            document.getElementById('intro-overlay').style.display = 'flex';
            
            // Set Intro Text
            const titles = { 'sinkfloat': 'Sink or Float?', 'matter': 'States of Matter' };
            document.getElementById('intro-title').innerText = titles[id] || 'Experiment';
        }

        function goHome() {
            window.speechSynthesis.cancel();
            document.getElementById('experiment-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
            // Hide all stages
            document.getElementById('sinkfloat-stage').style.display = 'none';
            document.getElementById('matter-stage').style.display = 'none';
        }

        // --- GLOBAL START BUTTON ---
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('intro-overlay').style.display = 'none';
            
            if (currentExperimentId === 'sinkfloat') {
                initSinkFloat();
            } else if (currentExperimentId === 'matter') {
                initMatter();
            }
        });

        // ==========================================
        //       EXPERIMENT 1: SINK OR FLOAT
        // ==========================================
        
        // Data
        const SF_ITEMS = [
            { id: 'apple', icon: 'üçé', name: 'Apple', density: 0.75, reason: "Apples have pockets of air inside, making them lighter than water." },
            { id: 'rock', icon: 'ü™®', name: 'Rock', density: 2.5, reason: "Rocks are heavy and solid. Denser than water!" },
            { id: 'duck', icon: 'ü¶Ü', name: 'Duck', density: 0.4, reason: "Filled with air like a balloon!" },
            { id: 'key', icon: 'üîë', name: 'Key', density: 7.0, reason: "Metal is packed tight and heavy." },
            { id: 'leaf', icon: 'üçÇ', name: 'Leaf', density: 0.2, reason: "Leaves are light and spread out." },
            { id: 'wood', icon: 'ü™µ', name: 'Block', density: 0.6, reason: "Wood has air tubes inside from when it was a tree." }
        ];

        // State & Elements
        const STATE = { INTRO: -1, ASK: 0, GUESS: 1, TEST: 2, RESULT: 3 };
        let sfState = STATE.INTRO;
        let currentItem = null;
        let currentHypothesis = null;
        let sfFrame = null;
        let draggedElement = null;
        let dragOffsetX = 0, dragOffsetY = 0;

        function initSinkFloat() {
            // UI Toggle
            document.getElementById('sinkfloat-stage').style.display = 'block';
            document.getElementById('matter-stage').style.display = 'none';
            document.getElementById('sinkfloat-ui').style.display = 'flex';
            document.getElementById('matter-ui').style.display = 'none';

            // Init Water Bubbles
            const water = document.getElementById('water');
            if(water.children.length === 0) {
                for(let i=0; i<6; i++) {
                    let b = document.createElement('div');
                    b.className = 'bubble';
                    b.style.left = Math.random() * 100 + '%';
                    b.style.width = (Math.random() * 10 + 5) + 'px';
                    b.style.height = b.style.width;
                    b.style.animationDuration = (Math.random() * 2 + 3) + 's';
                    b.style.animationDelay = Math.random() * 2 + 's';
                    water.appendChild(b);
                }
            }

            speak("Welcome to the Sink or Float Lab! Step 1: Pick an item.", () => { setupSinkFloatLevel(); });
        }

        function setupSinkFloatLevel() {
            const shelf = document.getElementById('shelf');
            shelf.innerHTML = '';
            SF_ITEMS.forEach(data => {
                const el = document.createElement('div');
                el.className = 'game-item';
                el.innerText = data.icon;
                el.style.position = 'relative';
                el.addEventListener('mousedown', (e) => handlePick(e, data, el));
                el.addEventListener('touchstart', (e) => handlePick(e, data, el), {passive: false});
                shelf.appendChild(el);
            });
            setSFPhase(STATE.ASK);
        }

        function setSFPhase(phase) {
            sfState = phase;
            document.getElementById('ph-1').classList.remove('active');
            document.getElementById('ph-2').classList.remove('active');
            document.getElementById('ph-3').classList.remove('active');

            if (phase === STATE.ASK) {
                document.getElementById('ph-1').classList.add('active');
            } else if (phase === STATE.GUESS) {
                document.getElementById('ph-2').classList.add('active');
            } else if (phase === STATE.TEST) {
                document.getElementById('ph-3').classList.add('active');
                speak("Drag it to the water!");
                document.getElementById('tank-container').classList.add('highlight-tank');
            }
        }

        function handlePick(e, data, element) {
            if (sfState !== STATE.ASK) return;
            e.preventDefault();
            currentItem = { data: data, element: element, x:0, y:0, vx:0, vy:0 };
            sfState = STATE.GUESS;
            setSFPhase(STATE.GUESS);
            
            element.style.transform = "scale(1.2)";
            document.getElementById('hypo-icon').innerText = data.icon;
            speak(`Will the ${data.name} sink or float? Make a guess!`, () => {
                document.getElementById('hypothesis-panel').style.display = 'block';
            });
        }

        window.makeHypothesis = function(willFloat) {
            currentHypothesis = willFloat;
            document.getElementById('hypothesis-panel').style.display = 'none';
            setSFPhase(STATE.TEST);
            prepareForDrag(currentItem.element);
        };

        function prepareForDrag(element) {
            const rect = element.getBoundingClientRect();
            element.style.position = 'absolute';
            element.style.left = rect.left + 'px';
            element.style.top = rect.top + 'px';
            document.body.appendChild(element); 
            currentItem.x = rect.left; currentItem.y = rect.top;

            const startDrag = (e) => {
                if(sfState !== STATE.TEST) return;
                const cX = e.touches ? e.touches[0].clientX : e.clientX;
                const cY = e.touches ? e.touches[0].clientY : e.clientY;
                dragOffsetX = cX - element.getBoundingClientRect().left;
                dragOffsetY = cY - element.getBoundingClientRect().top;
                draggedElement = element;
            };
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag, {passive: false});
        }

        window.addEventListener('mousemove', (e) => {
            if (!draggedElement) return;
            e.preventDefault();
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            currentItem.x = cX - dragOffsetX;
            currentItem.y = cY - dragOffsetY;
            draggedElement.style.left = currentItem.x + 'px';
            draggedElement.style.top = currentItem.y + 'px';
        });

        window.addEventListener('mouseup', () => {
            if (!draggedElement) return;
            draggedElement = null;
            if (sfState === STATE.TEST) checkDrop();
        });
        window.addEventListener('touchend', () => {
            if (!draggedElement) return;
            draggedElement = null;
            if (sfState === STATE.TEST) checkDrop();
        });

        function checkDrop() {
            const tank = document.getElementById('tank-container');
            const itemRect = currentItem.element.getBoundingClientRect();
            const tankRect = tank.getBoundingClientRect();
            
            if (itemRect.left+30 > tankRect.left && itemRect.right-30 < tankRect.right && itemRect.top > tankRect.top) {
                sfState = STATE.RESULT;
                tank.classList.remove('highlight-tank');
                startPhysics(tankRect);
            } else {
                speak("Missed! Drop it inside the water.");
            }
        }

        function startPhysics(tankRect) {
            speak("Let's see...");
            const water = document.getElementById('water');
            const waterY = water.getBoundingClientRect().top;
            const tankBot = water.getBoundingClientRect().bottom - 60;
            const density = currentItem.data.density;
            let frameCount = 0; 

            function loop() {
                frameCount++; 
                currentItem.vy += 0.5; // Gravity
                currentItem.y += currentItem.vy;

                if ((currentItem.y + 40) > waterY) {
                    currentItem.vy *= 0.85; // Drag
                    if (density < 1.0) {
                        const buoyancy = (1.0 - density) * 4.0;
                        currentItem.vy -= buoyancy;
                        if (currentItem.y + 40 < waterY + 10 && currentItem.vy < 0) currentItem.vy *= 0.6;
                    } else {
                        if (currentItem.vy > 5) currentItem.vy = 5;
                    }
                }
                
                if (currentItem.y > tankBot) {
                    currentItem.y = tankBot;
                    currentItem.vy = -currentItem.vy * 0.3;
                    if(Math.abs(currentItem.vy) < 0.5) currentItem.vy = 0;
                }

                currentItem.element.style.top = currentItem.y + 'px';
                const isStopped = Math.abs(currentItem.vy) < 0.1 && (currentItem.y + 40 > waterY);
                
                if (isStopped || frameCount > 300) {
                    cancelAnimationFrame(sfFrame);
                    concludeSF(density < 1.0);
                    return;
                }
                sfFrame = requestAnimationFrame(loop);
            }
            loop();
        }

        function concludeSF(actuallyFloats) {
            const correct = (currentHypothesis === actuallyFloats);
            const resText = actuallyFloats ? "It Floats!" : "It Sinks!";
            
            const card = document.getElementById('result-card');
            document.getElementById('res-icon').innerText = currentItem.data.icon;
            document.getElementById('res-title').innerText = resText;
            document.getElementById('res-desc').innerText = currentItem.data.reason;
            card.style.display = 'flex';
            card.style.borderColor = correct ? "#4CAF50" : "#FF9800";
            document.getElementById('res-title').style.color = correct ? "#2E7D32" : "#E65100";

            let txt = correct ? `You were right! ${resText} ${currentItem.data.reason}` : `Surprise! ${resText} ${currentItem.data.reason}`;
            if(correct) fireConfetti();
            speak(txt);

            document.getElementById('next-item-btn').onclick = () => {
                currentItem.element.remove();
                card.style.display = 'none';
                setupSinkFloatLevel();
            };
        }


        // ==========================================
        //       EXPERIMENT 2: STATES OF MATTER
        // ==========================================
        
        let matterTemp = 0; // 0 (Solid) to 2 (Gas)
        let matterState = 'solid';

        function initMatter() {
            // UI Setup
            document.getElementById('sinkfloat-stage').style.display = 'none';
            document.getElementById('matter-stage').style.display = 'flex';
            document.getElementById('sinkfloat-ui').style.display = 'none';
            document.getElementById('matter-ui').style.display = 'block';

            // Reset
            matterTemp = 0;
            updateMatterVisuals(true); // true = initial silent update
            document.getElementById('match-icon').innerText = "üìç";
            
            speak("Welcome to the Matter Lab! Everything is made of tiny particles. Use heat to see how they move!");
        }

        function changeTemp(dir) {
            matterTemp += dir;
            if (matterTemp < 0) matterTemp = 0;
            if (matterTemp > 2) matterTemp = 2;
            updateMatterVisuals(false);
        }

        function updateMatterVisuals(silent) {
            const sub = document.getElementById('matter-substance');
            const merc = document.getElementById('matter-mercury');
            const flame = document.getElementById('matter-flame');
            const disp = document.getElementById('temp-display');

            // Explanation Cards
            const cardSolid = document.getElementById('expl-solid');
            const cardLiquid = document.getElementById('expl-liquid');
            const cardGas = document.getElementById('expl-gas');

            // Reset Classes
            sub.className = 'substance';
            flame.classList.remove('active');
            
            // Remove active highlight from text
            cardSolid.classList.remove('active');
            cardLiquid.classList.remove('active');
            cardGas.classList.remove('active');

            if (matterTemp === 0) {
                // SOLID
                sub.classList.add('state-solid');
                merc.style.height = '20%';
                merc.style.background = '#2196F3'; // Cold blue
                disp.innerText = "Solid (Ice)";
                cardSolid.classList.add('active'); // Highlight
                
                if(!silent) speak("Freezing! The water particles are cold and holding hands tightly. They can't move, so they form hard Ice.");
            } else if (matterTemp === 1) {
                // LIQUID
                sub.classList.add('state-liquid');
                merc.style.height = '50%';
                merc.style.background = '#FF9800'; // Warm
                flame.classList.add('active'); 
                disp.innerText = "Liquid (Water)";
                cardLiquid.classList.add('active'); // Highlight

                if(!silent) speak("Melting! Heat gives the particles energy to dance and slide around. That is why Liquid water flows!");
            } else if (matterTemp === 2) {
                // GAS
                sub.classList.add('state-gas');
                merc.style.height = '90%';
                merc.style.background = '#F44336'; // Hot
                flame.classList.add('active');
                disp.innerText = "Gas (Steam)";
                cardGas.classList.add('active'); // Highlight

                if(!silent) speak("Boiling! The particles are super hot and fast! They fly apart and spread out to become Gas!");
            }
        }

        window.burnMatch = function() {
            const icon = document.getElementById('match-icon');
            if (icon.innerText === "üìç") {
                icon.innerText = "üî•";
                speak("Burning! Fire changes the wood into something new.", () => {
                    setTimeout(() => {
                        icon.innerText = "‚ö´"; // Ash
                        speak("Now it is Ash. Can we turn Ash back into a match? No! That is a Chemical Change. It is changed forever.");
                    }, 500);
                });
            } else {
                speak("It is already burnt! Chemical changes cannot be undone.");
            }
        }


        // --- UTILS ---
        let voices = [];
        window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };

        function speak(text, callback) {
            const bubble = document.getElementById('speech-bubble');
            const avatar = document.getElementById('robot-avatar');
            bubble.innerText = text;
            bubble.classList.add('visible');
            avatar.classList.add('speaking');

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; 
            const v = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
            if (v) utterance.voice = v;

            utterance.onend = () => {
                avatar.classList.remove('speaking');
                if (callback) callback();
            };
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        }

        const cvs = document.getElementById("confetti-canvas");
        const ctx = cvs.getContext("2d");
        let parts = [];
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        window.addEventListener('resize', () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; });

        function fireConfetti() {
            parts = [];
            for(let i=0; i<80; i++) parts.push({
                x: window.innerWidth/2, y: window.innerHeight/2,
                vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15-5,
                c: `hsl(${Math.random()*360},100%,50%)`, s: Math.random()*8+5
            });
            updConfetti();
        }
        function updConfetti() {
            ctx.clearRect(0,0,cvs.width,cvs.height);
            parts.forEach((p,i) => {
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.s*=0.96;
                ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,p.s,p.s);
                if(p.s<0.5) parts.splice(i,1);
            });
            if(parts.length) requestAnimationFrame(updConfetti);
        }
    </script>
</body>
</html>
