<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - Homeschool Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom animation for the background */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-white font-sans selection:bg-purple-500 selection:text-white overflow-x-hidden relative">

    <!-- Background Stars -->
    <div class="absolute inset-0 z-0 opacity-40" 
         style="background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px);
                background-size: 50px 50px, 25px 25px;
                background-position: 0 0, 25px 25px;">
    </div>

    <!-- Header -->
    <header class="relative z-10 p-6 flex justify-between items-center bg-slate-800/80 backdrop-blur-md border-b border-slate-700 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-indigo-600 rounded-lg shadow-[0_0_15px_rgba(79,70,229,0.5)]">
                <i data-lucide="rocket" class="w-8 h-8 text-white"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                    Mission Control
                </h1>
                <p id="status-text" class="text-slate-400 text-sm">Initializing launch sequence...</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative z-10 container mx-auto p-6 max-w-6xl">
        
        <!-- Loading State -->
        <div id="loading-state" class="flex flex-col items-center justify-center py-20 text-slate-400 animate-pulse hidden">
            <i data-lucide="rocket" class="w-12 h-12 mb-4 animate-bounce text-indigo-500"></i>
            <p>Scanning the galaxy for learning modules...</p>
        </div>

        <!-- Development Mode Warning (Localhost only) -->
        <div id="dev-warning" class="hidden bg-slate-800 p-8 rounded-2xl border border-yellow-500/50 text-center max-w-2xl mx-auto shadow-xl mb-8">
            <h2 class="text-xl font-bold text-yellow-400 mb-4">Development Mode</h2>
            <p class="text-slate-300 mb-4">We cannot auto-detect the repository because you are running on Localhost.</p>
            <div class="bg-slate-950 p-4 rounded-lg text-left font-mono text-sm text-green-400 mb-4 overflow-x-auto">
                <span class="text-slate-500">// Edit the LOCAL_CONFIG object in the script tag:</span><br/>
                const LOCAL_CONFIG = {<br/>
                &nbsp;&nbsp;username: <span class="text-yellow-300">'your-username'</span>,<br/>
                &nbsp;&nbsp;repo: <span class="text-yellow-300">'homeschool-repo'</span>,<br/>
                ...
            </div>
            <p class="text-sm text-slate-400">Once uploaded to GitHub Pages, this warning will disappear and auto-detection will kick in.</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden bg-red-900/50 border border-red-500/50 text-red-200 p-6 rounded-xl text-center mb-8 backdrop-blur-sm">
            <p class="font-bold text-lg mb-2">Comms Failure!</p>
            <p id="error-message"></p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20 text-slate-400 bg-slate-800/50 rounded-2xl border border-slate-700 border-dashed">
            <p class="text-xl">No mission folders found.</p>
            <p class="text-sm mt-2">Create folders in your repo to see them appear here.</p>
        </div>

        <!-- Grid Display -->
        <div id="mission-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Cards will be injected here by JavaScript -->
        </div>

    </main>

    <footer class="relative z-10 mt-20 p-6 text-center text-slate-500 text-sm">
        <p>Prepare for launch. Learning is an adventure.</p>
    </footer>

    <!-- Application Logic -->
    <script>
        // ------------------------------------------------------------------
        // CONFIGURATION AREA
        // ------------------------------------------------------------------
        const LOCAL_CONFIG = {
            username: 'your-username', // REPLACE THIS for local testing
            repo: 'homeschool-repo',   // REPLACE THIS for local testing
            branch: 'main'
        };
        // ------------------------------------------------------------------

        // Helper: Get Icon Name and Color based on subject
        function getIconDetails(name) {
            const lower = name.toLowerCase();
            if (lower.includes('math')) return { icon: 'calculator', color: 'text-blue-400' };
            if (lower.includes('science') || lower.includes('bio') || lower.includes('chem')) return { icon: 'flask-conical', color: 'text-green-400' };
            if (lower.includes('geo') || lower.includes('history') || lower.includes('social')) return { icon: 'globe', color: 'text-yellow-400' };
            if (lower.includes('art')) return { icon: 'palette', color: 'text-pink-400' };
            if (lower.includes('music')) return { icon: 'music', color: 'text-purple-400' };
            if (lower.includes('code') || lower.includes('tech')) return { icon: 'cpu', color: 'text-cyan-400' };
            return { icon: 'book-open', color: 'text-white' };
        }

        // Main Logic
        document.addEventListener('DOMContentLoaded', () => {
            const { hostname, pathname } = window.location;
            let config = LOCAL_CONFIG;
            let isAutoDetected = false;

            // 1. Auto-Detection Logic
            if (hostname.includes('github.io')) {
                const username = hostname.split('.')[0];
                const pathParts = pathname.split('/').filter(p => p.length > 0);
                const repo = pathParts.length > 0 ? pathParts[0] : `${username}.github.io`;
                
                config = { username, repo, branch: 'main' };
                isAutoDetected = true;
            }

            // Update UI based on detection
            const statusText = document.getElementById('status-text');
            if (isAutoDetected) {
                statusText.innerText = `Sector: ${config.repo}`;
            } else {
                statusText.innerText = "Select a mission to launch.";
                if (config.username === 'your-username') {
                    document.getElementById('dev-warning').classList.remove('hidden');
                }
            }

            // 2. Fetch Data (only if detected or local config is set)
            if (isAutoDetected || config.username !== 'your-username') {
                fetchRepoContents(config);
            } else {
                // Initialize icons even if we don't fetch
                lucide.createIcons();
            }
        });

        async function fetchRepoContents(config) {
            const loading = document.getElementById('loading-state');
            const errorDiv = document.getElementById('error-state');
            const errorMsg = document.getElementById('error-message');
            const emptyDiv = document.getElementById('empty-state');
            const grid = document.getElementById('mission-grid');

            // Reset UI
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            emptyDiv.classList.add('hidden');
            grid.innerHTML = '';

            try {
                // CHANGED: Use git/trees API with recursive=1 to get everything in one go
                // This allows us to find index.html files inside deep subfolders
                const response = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}/git/trees/${config.branch}?recursive=1`);

                if (!response.ok) {
                    if (response.status === 404) throw new Error(`Repository "${config.username}/${config.repo}" not found.`);
                    if (response.status === 403) throw new Error("API Limit reached. Try again later.");
                    throw new Error("Failed to fetch subjects.");
                }

                const data = await response.json();
                
                // Filter: Find all index.html files, exclude the root one (the dashboard itself)
                // data.tree is an array of objects like { path: "Math/index.html", type: "blob", ... }
                const missionFiles = data.tree.filter(item => 
                    item.path.toLowerCase().endsWith('index.html') && 
                    item.path.toLowerCase() !== 'index.html'
                );

                if (missionFiles.length === 0) {
                    emptyDiv.classList.remove('hidden');
                } else {
                    renderSubjects(missionFiles);
                }

            } catch (err) {
                errorMsg.innerText = err.message;
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                // Re-initialize icons for any new content
                lucide.createIcons();
            }
        }

        function renderSubjects(files) {
            const grid = document.getElementById('mission-grid');
            
            files.forEach(file => {
                // file.path is like "Math/Grade-1/index.html"
                
                // Get the folder structure (everything before the last slash)
                const folderPath = file.path.substring(0, file.path.lastIndexOf('/'));
                
                // Create a pretty display name: "Math › Grade 1"
                const displayName = folderPath
                    .replace(/\//g, ' › ')  // Replace slash with chevron
                    .replace(/-/g, ' ');    // Replace dashes with spaces

                // Determine icon based on the full path (so 'Math/Algebra' gets the math icon)
                const { icon, color } = getIconDetails(folderPath);
                
                // The link is simply the path from the root
                const link = `./${file.path}`;

                // Create Card HTML
                const cardHTML = `
                    <div onclick="window.location.href='${link}'" 
                         class="group relative bg-slate-800 hover:bg-indigo-900/40 rounded-2xl p-6 border border-slate-700 hover:border-indigo-500 cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_0_30px_rgba(79,70,229,0.3)] overflow-hidden">
                        
                        <!-- Card Glow Effect -->
                        <div class="absolute -right-10 -top-10 w-32 h-32 bg-indigo-500/20 blur-3xl rounded-full group-hover:bg-indigo-500/40 transition-all"></div>
                        
                        <div class="flex items-start justify-between relative z-10 mb-4">
                            <div class="p-3 bg-slate-900 rounded-xl shadow-inner group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="${icon}" class="w-8 h-8 ${color}"></i>
                            </div>
                            <i data-lucide="external-link" class="w-5 h-5 text-slate-500 group-hover:text-indigo-300 transition-colors opacity-0 group-hover:opacity-100"></i>
                        </div>

                        <h3 class="text-xl font-bold text-slate-100 group-hover:text-white mb-2 relative z-10 capitalize">
                            ${displayName}
                        </h3>
                        
                        <p class="text-slate-400 text-sm group-hover:text-slate-300 relative z-10 flex items-center gap-1">
                            <i data-lucide="star" class="w-3 h-3 text-yellow-500 fill-yellow-500"></i>
                            Begin Mission
                        </p>

                        <!-- Progress Bar (Visual) -->
                        <div class="w-full h-1 bg-slate-700 rounded-full mt-4 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 group-hover:w-full transition-all duration-700 ease-out"></div>
                        </div>
                    </div>
                `;
                
                grid.innerHTML += cardHTML;
            });
        }
    </script>
</body>
</html>
